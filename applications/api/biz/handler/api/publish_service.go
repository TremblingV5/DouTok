// Code generated by hertz generator.

package api

import (
	"bytes"
	"context"
	"fmt"
	"github.com/TremblingV5/DouTok/pkg/constants"
	"io"
	"log"

	"github.com/TremblingV5/DouTok/applications/api/biz/handler"
	"github.com/TremblingV5/DouTok/applications/api/initialize/rpc"
	"github.com/TremblingV5/DouTok/kitex_gen/publish"
	"github.com/TremblingV5/DouTok/pkg/errno"

	api "github.com/TremblingV5/DouTok/applications/api/biz/model/api"
	"github.com/cloudwego/hertz/pkg/app"
	"github.com/hertz-contrib/jwt"
)

// PublishAction .
//
//	@Tags		Publish视频投稿相关
//
//	@Summary	发布视频操作
//	@Description
//	@Param		title	formData	string	true	"视频标题"
//	@Param		data	formData	file	true	"视频数据"
//	@Success	200		{object}	publish.DouyinPublishActionResponse
//	@Failure	default	{object}	api.DouyinPublishActionResponse
//	@router		/douyin/publish/action [POST]
func PublishAction(ctx context.Context, c *app.RequestContext) {
	var err error
	var req api.DouyinPublishActionRequest
	// err = c.BindAndValidate(&req)
	// if err != nil {
	// 	handler.SendResponse(c, handler.BuildPublishActionResp(errno.ErrBind))
	// 	return
	// }

	req.Token = string(c.Cookie("token")) // c.PostForm("token")
	req.Title = c.PostForm("title")
	fs, _ := c.FormFile("data")
	f, _ := fs.Open()
	buff := new(bytes.Buffer)
	_, err = io.Copy(buff, f)
	if err != nil {
		log.Panicln(err)
	}
	req.Data = buff.Bytes()

	// TODO 这个绑定是否能够实现二进制文件的绑定（待测试）
	resp, err := rpc.PublishAction(ctx, rpc.PublishClient, &publish.DouyinPublishActionRequest{
		Title:  req.Title,
		Data:   req.Data,
		UserId: int64(c.Keys["user_id"].(float64)),
	})
	if err != nil {
		handler.SendResponse(c, handler.BuildPublishActionResp(errno.ConvertErr(err)))
		return
	}
	// TODO 此处直接返回了 rpc 的 resp
	handler.SendResponse(c, resp)
}

// PublishList .
//
//	@Tags		Publish视频投稿相关
//
//	@Summary	获取用户已发布视频的列表
//	@Description
//	@Param		req		query		api.DouyinPublishListRequest	true	"获取某个用户发布的视频列表的参数"
//	@Success	200		{object}	publish.DouyinPublishListResponse
//	@Failure	default	{object}	api.DouyinPublishListResponse
//	@router		/douyin/publish/list [GET]
func PublishList(ctx context.Context, c *app.RequestContext) {
	var err error
	var req api.DouyinPublishListRequest
	err = c.BindAndValidate(&req)
	payload, ok := c.Get("JWT_PAYLOAD")
	if !ok {
		handler.SendResponse(c, handler.BuildPublishListResp(errno.ErrBind))
		return
	}
	claims := payload.(jwt.MapClaims)
	fmt.Println(claims[constants.IdentityKey])

	if err != nil {
		handler.SendResponse(c, handler.BuildPublishListResp(errno.ErrBind))
		return
	}

	resp, err := rpc.PublishList(ctx, rpc.PublishClient, &publish.DouyinPublishListRequest{
		UserId: req.UserId,
	})
	if err != nil {
		handler.SendResponse(c, handler.BuildPublishListResp(errno.ConvertErr(err)))
		return
	}
	// TODO 此处直接返回了 rpc 的 resp
	handler.SendResponse(c, resp)
}
